<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <title>Vanilla: Ticker</title>

  <meta name="viewport" content="width=device-width,
    minimum-scale=1.0, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link href='http://fonts.googleapis.com/css?family=Roboto'
    rel='stylesheet' type='text/css'>

  <style>
    html,body {
      background: #cecece;
      font-family: 'Roboto', sans-serif;
      margin:0px;
      height: 100%;
    }
    #status {
      padding:10px;
      font-size: 8pt;
      color: #bebebe;
      background: #4D658D;
    }
    .card {
      padding:20px;
      font-size: 12pt;
      color: #4e4e4e;
      background: #efefef;
    }
    .card .symbol {
      width: 50px;
      display: inline-block;
    }
    .card .quote {
      width: 90px;
      display: inline-block;
      font-size: 16pt;
    }
    .card .when {
      font-size: 8pt;
      color: #aeaeae;
    }
    .green {
      color: #2dad2d;
    }
    .red {
      color: #bd2d2d;
    }
    .card .stat {
      width: 40px;
      display: inline-block;
    }
    .shadow {
      -moz-box-shadow: 0 0 5px #888;
      -webkit-box-shadow: 0 0 5px#888;
      box-shadow: 0 0 5px #888;
    }
  </style>
</head>

<body>
  <div class='card shadow' id='quote'></div>
  <script id='template-quote' type='text/ractive'>
    <div>
      <span class='symbol'>{{symbol}}</span>
      <span class='quote'>{{quote}}</span>
      <span class='stat {{ up ? "green" : "red" }}'>
        {{change}}
      </span>
      <span class='stat {{ up ? "green" : "red" }}'>
        {{percent}}
      </span>
    </div>
    <div class='when'>
      {{when}}
    </div>
  </script>

  <div id='status'></div>
  <script id='template-status' type='text/ractive'>
    <div style="margin-right:10px;float:right">
      {{format(last)}}
    </div>
    <div class='{{status == "OK" ? "green" : ""}}'>{{status}}</div>
  </script>


  <script src='http://cdn.ractivejs.org/latest/ractive.min.js'></script>

  <script>
    document.addEventListener("touchmove", function(event){
      event.preventDefault();
    });

    var rstatus = new Ractive({
      el: 'status',
      template: '#template-status',
      data: {
        status: '...',
        last: 0,
        format: function(last) {
          switch(last) {
            case 0:
              return 'now';
            case 1:
              return '1 sec ago';
            default:
              return last + ' secs ago';
          }
        },
      },
    });

    var ractive = new Ractive({
      el: 'quote',
      template: '#template-quote',
      data: {}
    });

    /* manage connection with the server */
    function reconnect() {
      rstatus.set('status', 'reconnect...');

      var uri = 'ws://' + document.domain;
      if (location.port) uri += ':' + location.port;
      var ws = new WebSocket(uri);

      ws.onopen = function() {
        rstatus.set('status', 'OK');
      }
      ws.onmessage = function(e) {
          ractive.set(JSON.parse(e.data));
          rstatus.set('last', 0);
      };
      ws.onclose = function() {
        setTimeout(reconnect, 1000);
      }
    }
    reconnect();

    /* update status for when we last heard from the server */
    setInterval( function () {
      rstatus.add('last', 1);
    }, 1000);
  </script>
</body>
</html>
